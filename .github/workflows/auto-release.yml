name: Auto Release on Version Change

on:
  push:
    branches:
      - main
    paths:
      - '.claude/VERSION'

permissions:
  contents: write
  pull-requests: write

jobs:
  detect-version:
    name: Detect Version Change
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.new_version }}
      should_release: ${{ steps.check.outputs.should_release }}
      commit_sha: ${{ github.sha }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get new version
        id: version
        run: |
          NEW_VERSION=$(cat .claude/VERSION | tr -d '\n')
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Version file: $NEW_VERSION"

      - name: Get latest release version
        id: latest
        run: |
          LATEST=$(gh release list --limit 1 --json tagName --jq '.[0].tagName' 2>/dev/null || echo "v0.0.0")
          LATEST_VERSION=${LATEST#v}
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "Latest release: $LATEST_VERSION"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if version changed
        id: check
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          LATEST_VERSION="${{ steps.latest.outputs.latest_version }}"

          if [ "$NEW_VERSION" != "$LATEST_VERSION" ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "✓ Version changed from $LATEST_VERSION to $NEW_VERSION"
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "Version unchanged ($NEW_VERSION) - skipping release"
          fi

  create-tag:
    name: Create Release Tag
    runs-on: ubuntu-latest
    needs: detect-version
    if: needs.detect-version.outputs.should_release == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Configure git
        run: |
          git config --global user.email "noreply@anthropic.com"
          git config --global user.name "Claude Code"

      - name: Create and push git tag
        env:
          VERSION: ${{ needs.detect-version.outputs.version }}
          COMMIT_SHA: ${{ needs.detect-version.outputs.commit_sha }}
        run: |
          # Verify we're on the right commit
          CURRENT_SHA=$(git rev-parse HEAD)
          if [ "$CURRENT_SHA" != "$COMMIT_SHA" ]; then
            echo "ERROR: Current SHA ($CURRENT_SHA) doesn't match expected SHA ($COMMIT_SHA)"
            exit 1
          fi

          git tag -a "v${VERSION}" -m "Release v${VERSION}"
          git push origin "v${VERSION}"
          echo "✓ Tag v${VERSION} created and pushed"

  build-binaries:
    name: Build Binaries - ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    needs: [detect-version, create-tag]
    if: needs.detect-version.outputs.should_release == 'true'
    strategy:
      matrix:
        include:
          # macOS x86_64
          - os: macos-latest
            name: macOS x86_64
            target: x86_64-apple-darwin
            use_cross: false
            build_dir: target/x86_64-apple-darwin/release
            archive: tar.gz

          # macOS ARM64 (M1/M2)
          - os: macos-latest
            name: macOS ARM64
            target: aarch64-apple-darwin
            use_cross: false
            build_dir: target/aarch64-apple-darwin/release
            archive: tar.gz

          # Linux x86_64
          - os: ubuntu-latest
            name: Linux x86_64
            target: x86_64-unknown-linux-gnu
            use_cross: false
            build_dir: target/x86_64-unknown-linux-gnu/release
            archive: tar.gz

          # Linux ARM64
          - os: ubuntu-latest
            name: Linux ARM64
            target: aarch64-unknown-linux-gnu
            use_cross: true
            build_dir: target/aarch64-unknown-linux-gnu/release
            archive: tar.gz

          # Windows x86_64
          - os: windows-latest
            name: Windows x86_64
            target: x86_64-pc-windows-msvc
            use_cross: false
            build_dir: target/x86_64-pc-windows-msvc/release
            archive: zip

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tool (ARM64 on Linux)
        if: matrix.use_cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('.claude/mcp-server/orchestr8-bin/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: .claude/mcp-server/orchestr8-bin/target
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-build-${{ hashFiles('.claude/mcp-server/orchestr8-bin/Cargo.lock') }}

      - name: Build binary
        working-directory: .claude/mcp-server/orchestr8-bin
        run: |
          if [ "${{ matrix.use_cross }}" = "true" ]; then
            cross build --release --target ${{ matrix.target }}
          else
            cargo build --release --target ${{ matrix.target }}
          fi
        shell: bash

      - name: Create archive (Unix)
        if: matrix.archive == 'tar.gz'
        working-directory: .claude/mcp-server/orchestr8-bin
        run: |
          VERSION="${{ needs.detect-version.outputs.version }}"
          BINARY_NAME="${{ matrix.name }}"
          BINARY_NAME=${BINARY_NAME// /-}
          BINARY_NAME=${BINARY_NAME//./-}
          BINARY_NAME=$(echo "$BINARY_NAME" | tr '[:upper:]' '[:lower:]')

          tar -czf orchestr8-bin-${BINARY_NAME}-$VERSION.tar.gz -C ${{ matrix.build_dir }} orchestr8-bin
          sha256sum orchestr8-bin-${BINARY_NAME}-$VERSION.tar.gz > orchestr8-bin-${BINARY_NAME}-$VERSION.tar.gz.sha256

          echo "Archive: orchestr8-bin-${BINARY_NAME}-$VERSION.tar.gz"
        shell: bash

      - name: Create archive (Windows)
        if: matrix.archive == 'zip'
        working-directory: .claude/mcp-server/orchestr8-bin
        run: |
          $VERSION = "${{ needs.detect-version.outputs.version }}"
          $BinaryName = "${{ matrix.name }}" -replace ' ', '-' -replace '\.', '-'
          $BinaryName = $BinaryName.tolower()

          7z a orchestr8-bin-${BinaryName}-$VERSION.zip -r ${{ matrix.build_dir }}/orchestr8-bin.exe
          Get-FileHash -Algorithm SHA256 orchestr8-bin-${BinaryName}-$VERSION.zip | ForEach-Object { "$($_.Hash)  orchestr8-bin-${BinaryName}-$VERSION.zip" } | Out-File -Encoding UTF8 orchestr8-bin-${BinaryName}-$VERSION.zip.sha256

          echo "Archive: orchestr8-bin-${BinaryName}-$VERSION.zip"
        shell: pwsh

      - name: Upload binary as artifact
        uses: actions/upload-artifact@v4
        with:
          name: orchestr8-binary-${{ matrix.target }}
          path: .claude/mcp-server/orchestr8-bin/orchestr8-bin-*

  finalize-release:
    name: Finalize GitHub Release with Binaries
    runs-on: ubuntu-latest
    needs: [detect-version, build-binaries]
    if: needs.detect-version.outputs.should_release == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all binaries from matrix builds
        uses: actions/download-artifact@v4
        with:
          path: binaries

      - name: Prepare binaries for release
        run: |
          echo "Collecting binaries from all builds..."
          mkdir -p release-binaries

          # Flatten artifact structure and verify checksums
          find binaries -name 'orchestr8-bin-*.tar.gz' -o -name 'orchestr8-bin-*.zip' | while read file; do
            cp "$file" release-binaries/
            echo "Copied: $(basename $file)"
          done

          find binaries -name '*.sha256' | while read file; do
            cp "$file" release-binaries/
            echo "Copied: $(basename $file)"
          done

          echo ""
          echo "Verifying checksums..."
          cd release-binaries
          for sha_file in *.sha256; do
            if [ -f "$sha_file" ]; then
              if sha256sum -c "$sha_file"; then
                echo "✓ Checksum verified: $sha_file"
              else
                echo "✗ Checksum failed: $sha_file"
                exit 1
              fi
            fi
          done

          echo ""
          ls -lh
          cd ..

      - name: Create GitHub Release with all binaries
        run: |
          VERSION="v${{ needs.detect-version.outputs.version }}"
          echo "Creating GitHub release $VERSION with binaries..."

          # Create release with release notes from CHANGELOG
          CHANGELOG_SECTION=$(sed -n "/^## \[${{ needs.detect-version.outputs.version }}\]/,/^## \[/p" .claude/CHANGELOG.md | head -n -1)

          # Create release (or update if it already exists)
          gh release create "$VERSION" \
            --title "$VERSION" \
            --notes "$CHANGELOG_SECTION" \
            release-binaries/* 2>/dev/null || \
          gh release upload "$VERSION" release-binaries/*

          echo "✓ GitHub release $VERSION created/updated with binaries"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          VERSION="v${{ needs.detect-version.outputs.version }}"
          echo "✅ Release process complete for $VERSION"
          echo "Release: https://github.com/${{ github.repository }}/releases/tag/$VERSION"
