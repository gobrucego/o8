name: Auto Release on Version Change

on:
  push:
    branches:
      - main
    paths:
      - '.claude/VERSION'

permissions:
  contents: write
  pull-requests: write

jobs:
  detect-version:
    name: Detect Version Change
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.new_version }}
      should_release: ${{ steps.check.outputs.should_release }}
      commit_sha: ${{ github.sha }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get new version
        id: version
        run: |
          NEW_VERSION=$(cat .claude/VERSION | tr -d '\n')
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Version file: $NEW_VERSION"

      - name: Get latest release version
        id: latest
        run: |
          LATEST=$(gh release list --limit 1 --json tagName --jq '.[0].tagName' 2>/dev/null || echo "v0.0.0")
          LATEST_VERSION=${LATEST#v}
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "Latest release: $LATEST_VERSION"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if version changed
        id: check
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          LATEST_VERSION="${{ steps.latest.outputs.latest_version }}"

          if [ "$NEW_VERSION" != "$LATEST_VERSION" ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "✓ Version changed from $LATEST_VERSION to $NEW_VERSION"
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "Version unchanged ($NEW_VERSION) - skipping release"
          fi

  create-tag:
    name: Create Release Tag
    runs-on: ubuntu-latest
    needs: detect-version
    if: needs.detect-version.outputs.should_release == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Configure git
        run: |
          git config --global user.email "noreply@anthropic.com"
          git config --global user.name "Claude Code"

      - name: Create and push git tag
        env:
          VERSION: ${{ needs.detect-version.outputs.version }}
          COMMIT_SHA: ${{ needs.detect-version.outputs.commit_sha }}
        run: |
          # Verify we're on the right commit
          CURRENT_SHA=$(git rev-parse HEAD)
          if [ "$CURRENT_SHA" != "$COMMIT_SHA" ]; then
            echo "ERROR: Current SHA ($CURRENT_SHA) doesn't match expected SHA ($COMMIT_SHA)"
            exit 1
          fi

          git tag -a "v${VERSION}" -m "Release v${VERSION}"
          git push origin "v${VERSION}"
          echo "✓ Tag v${VERSION} created and pushed"

  build-binaries:
    name: Build Local Binaries
    runs-on: ubuntu-latest
    needs: [detect-version, create-tag]
    if: needs.detect-version.outputs.should_release == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cross-compilation tools
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build binaries for all platforms
        working-directory: .claude/mcp-server/orchestr8-bin
        run: |
          VERSION="${{ needs.detect-version.outputs.version }}"
          echo "Building orchestr8-bin binaries for version $VERSION..."

          # Create output directory
          mkdir -p ../../binaries

          # macOS x86_64
          echo "Building macOS x86_64..."
          cargo build --release --target x86_64-apple-darwin
          tar -czf ../../binaries/orchestr8-bin-darwin-x86_64-$VERSION.tar.gz -C target/x86_64-apple-darwin/release orchestr8-bin

          # macOS ARM64
          echo "Building macOS ARM64..."
          cargo build --release --target aarch64-apple-darwin
          tar -czf ../../binaries/orchestr8-bin-darwin-arm64-$VERSION.tar.gz -C target/aarch64-apple-darwin/release orchestr8-bin

          # Linux x86_64
          echo "Building Linux x86_64..."
          cargo build --release --target x86_64-unknown-linux-gnu
          tar -czf ../../binaries/orchestr8-bin-linux-x86_64-$VERSION.tar.gz -C target/x86_64-unknown-linux-gnu/release orchestr8-bin

          # Linux ARM64
          echo "Building Linux ARM64..."
          cross build --release --target aarch64-unknown-linux-gnu
          tar -czf ../../binaries/orchestr8-bin-linux-arm64-$VERSION.tar.gz -C target/aarch64-unknown-linux-gnu/release orchestr8-bin

          # Windows x86_64
          echo "Building Windows x86_64..."
          cargo build --release --target x86_64-pc-windows-msvc
          cd ../../binaries && 7z a orchestr8-bin-windows-x86_64-$VERSION.zip ../../../target/x86_64-pc-windows-msvc/release/orchestr8-bin.exe && cd -

          echo "✓ All binaries built successfully"
          ls -lh ../../binaries/

      - name: Generate checksums
        working-directory: .claude/mcp-server/orchestr8-bin/../../binaries
        run: |
          for file in orchestr8-bin-*; do
            sha256sum "$file" > "$file.sha256"
          done
          echo "✓ Checksums generated"
          ls -lh

      - name: Upload binaries as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: orchestr8-binaries
          path: binaries/orchestr8-bin-*

  finalize-release:
    name: Finalize GitHub Release with Binaries
    runs-on: ubuntu-latest
    needs: [detect-version, build-binaries]
    if: needs.detect-version.outputs.should_release == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: orchestr8-binaries
          path: binaries

      - name: Create GitHub Release with binaries
        run: |
          VERSION="v${{ needs.detect-version.outputs.version }}"
          echo "Creating GitHub release $VERSION with binaries..."

          # Create release with release notes from CHANGELOG
          CHANGELOG_SECTION=$(sed -n "/^## \[${{ needs.detect-version.outputs.version }}\]/,/^## \[/p" .claude/CHANGELOG.md | head -n -1)

          gh release create "$VERSION" \
            --title "$VERSION" \
            --notes "$CHANGELOG_SECTION" \
            binaries/orchestr8-bin-*

          echo "✓ GitHub release $VERSION created with binaries"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          VERSION="v${{ needs.detect-version.outputs.version }}"
          echo "✅ Release process complete for $VERSION"
          echo "Release: https://github.com/${{ github.repository }}/releases/tag/$VERSION"
